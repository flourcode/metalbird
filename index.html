<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bird Detector Pro">
    <meta name="mobile-web-app-capable" content="yes">
    
    <meta name="theme-color" content="#0a0a0a">
    
    <meta name="description" content="Real-time aircraft tracker with route data - Premium version">
    <title>GIANT METAL BIRD DETECTOR v1.1 PRO</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #0a0a0a;
            --card-bg: #141414;
            --text-main: #ffffff; 
            --text-muted: #888888;
            --accent-yellow: #FFD700; 
            --accent-blue: #4da6ff;
            --accent-red: #ff3333;
			--accent-green: #779867 ;
            --border-color: #333333;
            --header-height: 70px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            height: 100vh; height: 100dvh;
            display: flex; flex-direction: column;
            overflow: hidden; position: fixed; width: 100%;
            -webkit-font-smoothing: antialiased;
        }

        .kiosk-header {
            height: var(--header-height); min-height: var(--header-height);
            padding: 12px 20px; display: flex; justify-content: space-between;
            align-items: center; border-bottom: 1px solid var(--border-color);
            background: var(--card-bg); flex-shrink: 0; z-index: 200;
        }

        .location-label {
            font-size: 14px; font-weight: 600; color: var(--text-muted);
            letter-spacing: 1px; text-transform: uppercase; font-family: 'Space Mono', monospace;
        }

        .header-controls { display: flex; align-items: center; gap: 12px; }

        .ctrl-element {
            background: var(--card-bg); border: 1px solid var(--border-color);
            color: var(--text-muted); padding: 4px 8px; border-radius: 4px;
            cursor: pointer; font-size: 10px; font-family: 'Space Mono', monospace;
            text-transform: uppercase; transition: all 0.2s ease; height: 26px;
            display: flex; align-items: center;
        }
        .ctrl-element:hover { border-color: var(--text-main); color: var(--text-main); }
        .ctrl-element:active { transform: scale(0.98); }
        .loc-btn.active, .compass-btn.active { background: var(--border-color); color: var(--text-main); }

        .radius-select {
            appearance: none; -webkit-appearance: none; text-align: center; outline: none;
            width: 70px; color: var(--text-main); background-color: var(--card-bg);
            border-radius: 0;
        }
        .radius-select option { background-color: #1a1a1a; color: #ffffff; }

        .main-display {
            flex: 1; display: flex; align-items: center; justify-content: center;
            padding: 0; overflow: hidden; min-height: 0;
        }

        .waiting-screen {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; text-align: center; gap: 20px; width: 100%;
        }

        .standby-clock {
            font-family: 'Space Mono', monospace; font-size: clamp(48px, 12vw, 120px);
            font-weight: 700; color: var(--text-main); line-height: 1;
        }

        .flight-card {
            width: 100%; height: 100%; background: transparent;
            display: flex; flex-direction: column; opacity: 1; position: relative;
        }

        /* Artificial Horizon */
        .artificial-horizon {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; overflow: hidden;
        }
        .ahrs-horizon-wrapper {
            width: 300%; height: 300%; position: absolute; top: -100%; left: -100%;
            will-change: transform; transition: transform 0.3s linear;
        }
        .ahrs-sky { width: 100%; height: 50%; background: #2a2a2a; position: absolute; top: 0; left: 0; }
        .ahrs-ground {
            width: 100%; height: 50%; background: var(--bg-color);
            position: absolute; top: 50%; left: 0; border-top: 2px solid rgba(255, 255, 255, 0.3);
        }

        /* CROSSHAIR & TARGET LOCK SYSTEM */
        .ahrs-crosshair {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 200px; height: 80px; z-index: 100; pointer-events: none;
            transition: all 0.2s ease;
        }
        
        /* Default White Crosshair */
        .ahrs-crosshair svg path, 
        .ahrs-crosshair svg circle, 
        .ahrs-crosshair svg line {
            stroke: rgba(255,255,255,0.9);
            fill: rgba(255,255,255,0.9);
            transition: stroke 0.2s, fill 0.2s;
        }

        /* LOCKED STATE (Green) */
        .ahrs-crosshair.locked svg path, 
        .ahrs-crosshair.locked svg circle, 
        .ahrs-crosshair.locked svg line {
            stroke: var(--accent-green);
            fill: var(--accent-green);
            filter: drop-shadow(0 0 8px var(--accent-green));
        }

        .lock-status {
            position: fixed; top: 45%; left: 50%; transform: translate(-50%, -50%);
            color: var(--accent-green); font-family: 'Space Mono', monospace;
            font-weight: 700; font-size: 14px; letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.6);
            opacity: 0; transition: opacity 0.2s; z-index: 101;
            border: 1px solid var(--accent-green); padding: 4px 8px; background: rgba(0,0,0,0.7);
        }
        .lock-status.visible { opacity: 1; }

        .bearing-indicator {
            position: fixed; top: 53%; left: 50%; transform: translateX(-50%);
            font-family: 'Space Mono', monospace; font-size: 10px; color: rgba(255,255,255,0.5);
            z-index: 101; text-align: center; pointer-events: none;
        }

        /* HUD Elements */
        .hud-top {
            position: fixed; top: clamp(80px, 12vh, 120px); left: 0; right: 0;
            text-align: center; z-index: 50; pointer-events: none;
        }
        .callsign-row {
            font-size: clamp(48px, 10vw, 120px); font-weight: 900; color: rgba(255, 255, 255, 0.95);
            letter-spacing: 2px; line-height: 0.9; text-shadow: 0 0 20px rgba(0,0,0,0.8);
            margin-bottom: clamp(8px, 1.5vh, 16px);
        }
        .aircraft-type {
            font-size: clamp(28px, 6vw, 44px); color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase; letter-spacing: 3px; font-weight: 600;
            text-shadow: 0 0 15px rgba(0,0,0,0.9);
        }
        .hex-code {
            font-family: 'Space Mono', monospace; font-size: clamp(11px, 2vw, 14px);
            color: rgba(255, 255, 255, 0.4); margin-top: 6px; text-shadow: 0 0 10px rgba(0,0,0,0.9);
            display: none;
        }

        /* Route Display */
        .hud-route {
            position: fixed; top: 58%; left: 50%; transform: translateX(-50%);
            display: flex; align-items: center; gap: clamp(16px, 3vw, 32px);
            z-index: 50; pointer-events: none;
        }
        .route-airport { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .airport-code {
            font-size: clamp(42px, 8vw, 84px); font-weight: 900; color: rgba(255, 255, 255, 0.95);
            letter-spacing: -1px; line-height: 1; text-shadow: 0 0 20px rgba(0,0,0,0.9);
        }
        .airport-city {
            font-size: clamp(10px, 2vw, 14px); color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase; letter-spacing: 1.5px; font-weight: 600;
            text-shadow: 0 0 10px rgba(0,0,0,0.9);
        }
        .route-arrow {
            font-size: clamp(24px, 4vw, 40px); color: rgba(255, 255, 255, 0.6);
            text-shadow: 0 0 15px rgba(0,0,0,0.9);
        }

        /* HUD Heading Top */
        .hud-heading {
            position: fixed; top: clamp(16px, 2.5vh, 24px); left: 50%;
            transform: translateX(-50%); font-family: 'Space Mono', monospace;
            font-size: clamp(32px, 6vw, 56px); font-weight: 700; color: rgba(255, 255, 255, 0.9);
            z-index: 60; text-shadow: 0 0 20px rgba(0,0,0,0.9); letter-spacing: 2px;
        }

        /* Corners */
        .hud-corner { position: fixed; z-index: 50; pointer-events: none; }
        .hud-tl { top: clamp(16px, 2.5vh, 24px); left: clamp(16px, 2.5vw, 24px); }
        .hud-tr { top: clamp(16px, 2.5vh, 24px); right: clamp(16px, 2.5vw, 24px); text-align: right; }
        .hud-bl { bottom: clamp(16px, 2.5vh, 24px); left: clamp(16px, 2.5vw, 24px); }
        .hud-br { bottom: clamp(16px, 2.5vh, 24px); right: clamp(16px, 2.5vw, 24px); text-align: right; }
        .hud-label {
            font-size: clamp(9px, 1.5vw, 11px); color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase; letter-spacing: 1.5px; font-weight: 600; margin-bottom: 4px;
            text-shadow: 0 0 10px rgba(0,0,0,0.9);
        }
        .hud-value {
            font-family: 'Space Mono', monospace; font-size: clamp(24px, 4.5vw, 42px);
            font-weight: 700; color: rgba(255, 255, 255, 0.95); line-height: 1;
            white-space: nowrap; text-shadow: 0 0 20px rgba(0,0,0,0.9);
        }

        /* Mobile Opts */
        @media (max-width: 768px) {
            .kiosk-header { height: 60px; min-height: 60px; padding: 10px 15px; }
            .location-label { font-size: 12px; }
            .ctrl-element { font-size: 9px; padding: 3px 6px; height: 24px; }
            .loc-btn { min-width: 70px; }
            .hud-top { top: clamp(90px, 15vh, 140px); }
            .hud-route { gap: clamp(12px, 2.5vw, 24px); }
        }
        @media (max-width: 768px) and (orientation: landscape) {
            .kiosk-header { height: 50px; min-height: 50px; padding: 8px 15px; }
            .hud-top { top: clamp(70px, 12vh, 90px); }
            .callsign-row { font-size: clamp(36px, 8vh, 80px); }
            .airport-code { font-size: clamp(32px, 7vh, 64px); }
            .hud-route { top: 62%; gap: clamp(12px, 2.5vw, 20px); }
        }
    </style>
</head>
<body>
    <div class="kiosk-header">
        <div class="location-label" id="location-display">AWAITING GEO...</div>
        <div class="header-controls">
            <button class="ctrl-element loc-btn" id="locToggle">GPS</button>
            <button class="ctrl-element compass-btn" id="compassToggle">COMPASS</button>
            
            <select class="ctrl-element radius-select" id="radiusSelect">
                <option value="3" selected>3 mi</option>
                <option value="5">5 mi</option>
                <option value="10">10 mi</option>
            </select>
        </div>
    </div>

    <div class="main-display">
        <div class="waiting-screen" id="waitingView">
            <div class="standby-clock" id="standbyClock">--:--:--</div>
            <div class="standby-label">SCANNING FOR AIRCRAFT</div>
            <div class="standby-location" id="standbyLocation">Enable GPS & Compass</div>
        </div>

        <div class="flight-card" id="flightView" style="display: none;">
            <div class="artificial-horizon">
                <div class="ahrs-horizon-wrapper" id="ahrs-horizon">
                    <div class="ahrs-sky"></div>
                    <div class="ahrs-ground"></div>
                </div>
            </div>

            <div class="lock-status" id="lockStatus">TARGET LOCKED</div>

            <div class="ahrs-crosshair" id="crosshair">
                <svg viewBox="0 0 200 80" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="100" cy="40" r="3" fill="inherit"/>
                    <line x1="30" y1="40" x2="85" y2="40" stroke="inherit" stroke-width="3"/>
                    <line x1="30" y1="40" x2="30" y2="50" stroke="inherit" stroke-width="3"/>
                    <line x1="115" y1="40" x2="170" y2="40" stroke="inherit" stroke-width="3"/>
                    <line x1="170" y1="40" x2="170" y2="50" stroke="inherit" stroke-width="3"/>
                </svg>
            </div>

            <div class="bearing-indicator" id="bearingDebug"></div>

            <div class="hud-heading" id="dispHdg">000Â°</div>

            <div class="hud-top">
                <div class="callsign-row" id="dispCallsign">---</div>
                <div class="aircraft-type" id="dispType">---</div>
            </div>

            <div class="hud-route">
                <div class="route-airport">
                    <div class="airport-code" id="dispDep">___</div>
                    <div class="airport-city" id="dispCityDep"></div>
                </div>
                <div class="route-arrow">â†’</div>
                <div class="route-airport">
                    <div class="airport-code" id="dispArr">___</div>
                    <div class="airport-city" id="dispCityArr"></div>
                </div>
            </div>

            <div class="hud-corner hud-tl">
                <div class="hud-label">Distance</div>
                <div class="hud-value" id="dispDist">--</div>
            </div>
            <div class="hud-corner hud-tr">
                <div class="hud-label">Altitude</div>
                <div class="hud-value" id="dispAlt">--</div>
            </div>
            <div class="hud-corner hud-bl">
                <div class="hud-label">Speed</div>
                <div class="hud-value" id="dispSpd">--</div>
            </div>
            <div class="hud-corner hud-br">
                <div class="hud-label">Status</div>
                <div class="hud-value" id="dispStatus">--</div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            AIRCRAFT_API: "https://api.airplanes.live/v2/point/",
            AWS_PROXY: "https://yd7ndqoiq5.execute-api.us-east-1.amazonaws.com/prod/",
            DEFAULT_LAT: 38.71,
            DEFAULT_LON: -77.26,
            POLL_INTERVAL: 3000,
            FADE_DURATION: 600,
            CLOCK_UPDATE: 1000,
            ROUTE_CACHE_DURATION: 3600000,
            FETCH_TIMEOUT: 8000,
            LOCK_THRESHOLD: 15 // Degrees to trigger "Locked"
        };

        // State
        const state = {
            gpsEnabled: false,
            compassEnabled: false,
            userLat: CONFIG.DEFAULT_LAT,
            userLon: CONFIG.DEFAULT_LON,
            userHeading: 0, // Phone compass heading
            targetBearing: 0, // Bearing to plane
            searchRadius: 3,
            nearbyPlanes: [],
            currentPlaneHex: null,
            lastFetch: 0,
            routeCache: new Map(),
            routeCacheExpiry: new Map(),
            lastHeading: null,
            lastHeadingTime: null
        };

        // DOM Elements
        const dom = {
            locDisplay: document.getElementById('location-display'),
            locToggle: document.getElementById('locToggle'),
            compassToggle: document.getElementById('compassToggle'),
            radiusSelect: document.getElementById('radiusSelect'),
            waitingView: document.getElementById('waitingView'),
            flightView: document.getElementById('flightView'),
            standbyClock: document.getElementById('standbyClock'),
            standbyLocation: document.getElementById('standbyLocation'),
            dispCallsign: document.getElementById('dispCallsign'),
            dispType: document.getElementById('dispType'),
            dispDep: document.getElementById('dispDep'),
            dispArr: document.getElementById('dispArr'),
            dispCityDep: document.getElementById('dispCityDep'),
            dispCityArr: document.getElementById('dispCityArr'),
            dispDist: document.getElementById('dispDist'),
            dispAlt: document.getElementById('dispAlt'),
            dispSpd: document.getElementById('dispSpd'),
            dispHdg: document.getElementById('dispHdg'),
            dispStatus: document.getElementById('dispStatus'),
            ahrsHorizon: document.getElementById('ahrs-horizon'),
            crosshair: document.getElementById('crosshair'),
            lockStatus: document.getElementById('lockStatus'),
            bearingDebug: document.getElementById('bearingDebug')
        };

        // Aircraft Type Mapping
        const AIRCRAFT_TYPES = {
            "B737": "Boeing 737", "B738": "Boeing 737-800", "A320": "Airbus A320", 
            "A321": "Airbus A321", "B77W": "Boeing 777", "B789": "Dreamliner",
            "C172": "Cessna 172", "CRJ9": "CRJ-900", "E175": "Embraer 175"
        };
        const AIRPORT_DB = {
            "JFK": "New York", "LAX": "Los Angeles", "ORD": "Chicago", "ATL": "Atlanta",
            "LHR": "London", "CDG": "Paris", "DXB": "Dubai", "HND": "Tokyo"
        };

        function init() {
            console.log("ðŸš€ PRO v1.2 with MAG LOCK");
            dom.locToggle.addEventListener('click', toggleGPS);
            dom.compassToggle.addEventListener('click', requestCompass);
            
            dom.radiusSelect.addEventListener('change', (e) => {
                state.searchRadius = parseInt(e.target.value);
                fetchNearbyAircraft();
            });

            startStandbyClock();
            setInterval(fetchNearbyAircraft, CONFIG.POLL_INTERVAL);
            requestGPS();
        }

        // --- COMPASS / MAGNETOMETER LOGIC ---
        function requestCompass() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                // iOS 13+ requirement
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            enableCompass();
                        } else {
                            alert("Permission denied. Compass features disabled.");
                        }
                    })
                    .catch(console.error);
            } else {
                // Non-iOS 13+ devices
                enableCompass();
            }
        }

        function enableCompass() {
            window.addEventListener('deviceorientation', handleOrientation);
            state.compassEnabled = true;
            dom.compassToggle.textContent = "ON";
            dom.compassToggle.classList.add('active');
        }

        function handleOrientation(event) {
            // iOS usually provides webkitCompassHeading
            let heading = null;
            
            if (event.webkitCompassHeading) {
                // iOS
                heading = event.webkitCompassHeading;
            } else if (event.alpha) {
                // Android (alpha is not always true north, simplified here)
                heading = 360 - event.alpha; 
            }

            if (heading !== null) {
                state.userHeading = heading;
                checkTargetLock();
            }
        }

        function checkTargetLock() {
            if (!state.compassEnabled || !state.nearbyPlanes.length) return;

            // Calculate difference between user heading and target bearing
            let diff = Math.abs(state.userHeading - state.targetBearing);
            if (diff > 180) diff = 360 - diff; // Handle wrapping

            // Debug Text
            dom.bearingDebug.textContent = `HDG ${Math.round(state.userHeading)}Â° / TRG ${Math.round(state.targetBearing)}Â°`;

            if (diff < CONFIG.LOCK_THRESHOLD) {
                // LOCKED
                dom.crosshair.classList.add('locked');
                dom.lockStatus.classList.add('visible');
                if (navigator.vibrate) navigator.vibrate(50); // Haptic feedback
            } else {
                // UNLOCKED
                dom.crosshair.classList.remove('locked');
                dom.lockStatus.classList.remove('visible');
            }
        }

        // --- GPS LOGIC ---
        function requestGPS() {
            if (!navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    state.gpsEnabled = true;
                    state.userLat = position.coords.latitude;
                    state.userLon = position.coords.longitude;
                    dom.locDisplay.textContent = `${state.userLat.toFixed(4)}, ${state.userLon.toFixed(4)}`;
                    dom.locToggle.textContent = "REVOKE";
                    dom.locToggle.classList.add('active');
                    fetchNearbyAircraft();
                },
                (err) => {
                    console.error(err);
                    state.gpsEnabled = false;
                    dom.locToggle.textContent = "GPS";
                }
            );
        }

        function toggleGPS() {
            if (state.gpsEnabled) {
                state.gpsEnabled = false;
                dom.locToggle.textContent = "GPS";
                dom.locToggle.classList.remove('active');
            } else {
                requestGPS();
            }
        }

        // --- DATA FETCHING ---
        async function fetchNearbyAircraft() {
            if (!state.gpsEnabled) return;
            const now = Date.now();
            if (now - state.lastFetch < CONFIG.POLL_INTERVAL - 100) return;
            state.lastFetch = now;

            try {
                const res = await fetch(`${CONFIG.AIRCRAFT_API}${state.userLat}/${state.userLon}/${state.searchRadius}`);
                if (!res.ok) throw new Error('API Error');
                const json = await res.json();

                if (json.ac && json.ac.length > 0) {
                    const planes = json.ac
                        .filter(p => p.lat && p.lon)
                        .map(p => ({
                            ...p,
                            distance: getDist(state.userLat, state.userLon, p.lat, p.lon)
                        }))
                        .filter(p => p.distance <= state.searchRadius)
                        .sort((a, b) => a.distance - b.distance);

                    state.nearbyPlanes = planes;
                    if (planes.length > 0) updateDisplay();
                } else {
                    state.nearbyPlanes = [];
                    dom.flightView.style.display = 'none';
                    dom.waitingView.style.display = 'flex';
                }
            } catch (e) { console.error(e); }
        }

        function updateDisplay() {
            if (!state.nearbyPlanes.length) return;
            
            const plane = state.nearbyPlanes[0];
            
            // Calculate Target Bearing for Compass Lock
            state.targetBearing = getBearing(state.userLat, state.userLon, plane.lat, plane.lon);
            
            if (state.currentPlaneHex !== plane.hex) {
                // New plane detected
                state.currentPlaneHex = plane.hex;
                fetchRoute(plane.flight);
                dom.waitingView.style.display = 'none';
                dom.flightView.style.display = 'flex';
            }

            // Basic Data
            const callsign = plane.flight ? plane.flight.trim() : plane.r || plane.hex;
            dom.dispCallsign.textContent = callsign;
            dom.dispType.textContent = AIRCRAFT_TYPES[plane.t] || plane.t || "UNKNOWN";
            dom.dispDist.textContent = plane.distance.toFixed(1) + " MI";
            
            const alt = plane.alt_baro;
            dom.dispAlt.textContent = alt === 'ground' ? 'GND' : Math.round(alt).toLocaleString() + ' FT';
            dom.dispSpd.textContent = Math.round(plane.gs || 0) + ' KTS';
            dom.dispHdg.textContent = Math.round(plane.track || 0).toString().padStart(3,'0') + 'Â°';

            // Status
            let status = "CRUISING";
            const vrate = plane.baro_rate || 0;
            if(alt === "ground") status = "TAXI";
            else if(vrate > 500) status = "CLIMB";
            else if(vrate < -500) status = "DESCEND";
            dom.dispStatus.textContent = status;

            updateArtificialHorizon(plane);
            // Trigger target lock check immediately
            checkTargetLock();
        }

        // --- ROUTE API ---
        async function fetchRoute(callsign) {
            dom.dispDep.textContent = "___"; dom.dispArr.textContent = "___";
            dom.dispCityDep.textContent = ""; dom.dispCityArr.textContent = "";
            
            if(!callsign || callsign.length < 3 || /^N\d/.test(callsign)) {
                dom.dispDep.textContent = "---"; dom.dispArr.textContent = "---";
                return;
            }

            const trimmed = callsign.trim().toUpperCase();
            if(state.routeCache.has(trimmed)) {
                 updateRouteDisplay(state.routeCache.get(trimmed));
                 return;
            }

            try {
                const res = await fetch(`${CONFIG.AWS_PROXY}?callsign=${trimmed}`);
                const json = await res.json();
                if(json.flights && json.flights.length > 0) {
                    const f = json.flights[0];
                    const data = {
                        dep: f.origin?.code_iata || "UNK",
                        arr: f.destination?.code_iata || "UNK",
                        depCity: f.origin?.city || AIRPORT_DB[f.origin?.code_iata] || "",
                        arrCity: f.destination?.city || AIRPORT_DB[f.destination?.code_iata] || ""
                    };
                    state.routeCache.set(trimmed, data);
                    updateRouteDisplay(data);
                }
            } catch(e) {}
        }

        function updateRouteDisplay(data) {
            dom.dispDep.textContent = data.dep;
            dom.dispArr.textContent = data.arr;
            dom.dispCityDep.textContent = data.depCity;
            dom.dispCityArr.textContent = data.arrCity;
        }

        // --- VISUALS ---
        function updateArtificialHorizon(plane) {
            const now = Date.now();
            const vrate = plane.baro_rate || 0;
            const speed = plane.gs || 100;
            const pitchPixels = (vrate / speed) * 4; 

            let bankAngle = 0;
            if (plane.track !== undefined && state.lastHeading !== null) {
                const dt = (now - state.lastHeadingTime) / 1000;
                if (dt > 0.5 && dt < 10) {
                    let diff = plane.track - state.lastHeading;
                    if (diff > 180) diff -= 360; if (diff < -180) diff += 360;
                    bankAngle = Math.max(-30, Math.min(30, (diff/dt) * 5));
                }
            }
            
            if (plane.track !== undefined) {
                state.lastHeading = plane.track;
                state.lastHeadingTime = now;
            }
            
            dom.ahrsHorizon.style.transform = `rotate(${-bankAngle}deg) translateY(${pitchPixels}px)`;
        }

        // --- MATH ---
        function getDist(lat1, lon1, lat2, lon2) {
            const R = 3958.8;
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function getBearing(startLat, startLon, destLat, destLon) {
            startLat = deg2rad(startLat); startLon = deg2rad(startLon);
            destLat = deg2rad(destLat); destLon = deg2rad(destLon);
            const y = Math.sin(destLon - startLon) * Math.cos(destLat);
            const x = Math.cos(startLat) * Math.sin(destLat) -
                      Math.sin(startLat) * Math.cos(destLat) * Math.cos(destLon - startLon);
            const brng = Math.atan2(y, x);
            return (brng * 180 / Math.PI + 360) % 360;
        }

        function deg2rad(deg) { return deg * (Math.PI/180); }
        function startStandbyClock() {
            setInterval(() => {
                const d = new Date();
                dom.standbyClock.textContent = d.toLocaleTimeString('en-GB');
            }, 1000);
        }

        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
        else init();
    </script>
</body>
</html>